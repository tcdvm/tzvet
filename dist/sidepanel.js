import"./chunks/modulepreload-polyfill.js";/* empty css             */const k=document.getElementById("normalize"),s=document.getElementById("status"),C="Please verify any and all data processed by this extension.",M="Ready";function N(e){return!e||!e.hasMore?"":` More results may exist (page ${e.current} of ${e.total}). Load additional pages or increase items/page.`}const w=document.getElementById("extractLabTrends"),f=document.getElementById("storedTrends"),m=document.getElementById("clearTrends"),h=document.getElementById("autoOpenTrends"),v=document.getElementById("tabTools"),L=document.getElementById("tabHowtos"),x=document.querySelectorAll("[data-tab]");x.length&&x.forEach(e=>{e.addEventListener("click",()=>{const n=e.dataset.tab;x.forEach(t=>t.classList.remove("tab-active")),e.classList.add("tab-active"),v&&v.classList.toggle("hidden",n!=="tools"),L&&L.classList.toggle("hidden",n!=="howtos"),location.hash!==`#${n}`&&history.replaceState(null,"",`#${n}`)})});const O=location.hash==="#howtos"?"howtos":"tools",B=Array.from(x).find(e=>e.dataset.tab===O);B&&B.click();w&&w.addEventListener("click",async()=>{var e,n;s.textContent="Extracting lab trends...",w.disabled=!0;try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(t!=null&&t.id)){s.textContent="No active tab";return}const o=await y(t.id,{type:"EXTRACT_LAB_TRENDS"});if(!o.ok){s.textContent=`Content script unavailable: ${I(o.error)}`,console.warn("sendMessage failed after retry:",o.error);return}const r=o.res;if(!r||r.ok===!1){s.textContent=(r==null?void 0:r.error)||"Extraction failed";return}const a=((e=r.patient)==null?void 0:e.id)||null,c=new Date().toISOString();let i={...r,updatedAt:c};if(a){const u=(await chrome.storage.local.get({labTrendsByPatient:{}})).labTrendsByPatient||{},p=((n=u[a])==null?void 0:n.observations)||[],b=q(p,r.observations||[]);u[a]={patient:r.patient,observations:b,updatedAt:c},await chrome.storage.local.set({labTrendsByPatient:u}),i={...r,observations:b,updatedAt:c}}const g=`labTrends:${Date.now()}-${Math.random().toString(36).slice(2,8)}`;await chrome.storage.session.set({[g]:i});const l=h?h.checked:!0,d=N(r.pagination);if(l){s.textContent=`Lab trends found: ${r.count}. Opening trends...${d}`;const T=chrome.runtime.getURL(`trends/index.html?key=${encodeURIComponent(g)}`);await chrome.tabs.create({url:T})}else s.textContent=`Lab trends found: ${r.count}. Cached.${d}`;console.log("Lab trends payload",i),E()}finally{w.disabled=!1}});s&&(s.textContent=C,setTimeout(()=>{s.textContent===C&&(s.textContent=M)},4e3));chrome.storage.sync.get({normalizeSpecies:!1,headerHidden:!1,qtipPlaceholder:!1},e=>{k.checked=e.normalizeSpecies;const n=document.getElementById("toggleHeader");n&&(n.checked=e.headerHidden);const t=document.getElementById("toggleQtip");t&&(t.checked=e.qtipPlaceholder)});chrome.storage.sync.get({autoOpenTrends:!0},e=>{h&&(h.checked=e.autoOpenTrends)});h&&h.addEventListener("change",e=>{chrome.storage.sync.set({autoOpenTrends:!!e.target.checked})});const $=document.getElementById("toggleHeader");$&&$.addEventListener("change",async e=>{const n=!!e.target.checked;chrome.storage.sync.set({headerHidden:n},async()=>{s.textContent=n?"Header hidden":"Header visible";const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t!=null&&t.id){const o=await y(t.id,{type:"HEADER_TOGGLE",hidden:n});o.ok||(s.textContent="Header toggle failed",console.warn("sendMessage failed after retry:",o.error))}})});const S=document.getElementById("toggleQtip");S&&S.addEventListener("change",async e=>{const n=!!e.target.checked;chrome.storage.sync.set({qtipPlaceholder:n},async()=>{s.textContent=n?"Pop-ups replaced":"Pop-ups restored";const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t!=null&&t.id){const o=await y(t.id,{type:"QTIP_TOGGLE",enabled:n});o.ok||(s.textContent="Q-tip toggle failed",console.warn("sendMessage failed after retry:",o.error))}})});async function y(e,n){return new Promise(t=>{chrome.tabs.sendMessage(e,n,async o=>{if(chrome.runtime.lastError&&/Receiving end does not exist/.test(chrome.runtime.lastError.message||"")){try{await chrome.scripting.executeScript({target:{tabId:e},files:["content-script.js"]})}catch(r){return t({ok:!1,error:r})}setTimeout(()=>{chrome.tabs.sendMessage(e,n,r=>chrome.runtime.lastError?t({ok:!1,error:chrome.runtime.lastError}):t({ok:!0,res:r}))},200);return}return chrome.runtime.lastError?t({ok:!1,error:chrome.runtime.lastError}):t({ok:!0,res:o})})})}function I(e){if(!e)return"unknown error";if(typeof e=="string")return e;if(e.message)return e.message;try{return JSON.stringify(e)}catch{return String(e)}}k.addEventListener("change",async e=>{const n=!!e.target.checked;chrome.storage.sync.set({normalizeSpecies:n},async()=>{s.textContent=n?"Species labels fixed":"Species labels original - refresh page";const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t!=null&&t.id){const o=await y(t.id,{type:"NORMALIZE_TOGGLE",enabled:n});if(!o.ok){s.textContent="No content script on active tab",console.warn("sendMessage failed after retry:",o.error);return}console.log("Normalize toggle response",o.res)}})});k.addEventListener("dblclick",async()=>{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(e!=null&&e.id){const n=await y(e.id,{type:"NORMALIZE_NOW"});if(!n.ok){s.textContent="No content script on active tab",console.warn("sendMessage failed after retry:",n.error);return}console.log("Normalize-now response",n.res)}});function P(e){if(f){if(!e.length){f.textContent="None stored yet.",m&&(m.disabled=!0);return}m&&(m.disabled=!1),f.innerHTML="",e.forEach(({key:n,patient:t,updatedAt:o})=>{const r=document.createElement("div"),a=(t==null?void 0:t.name)||"Unknown",c=(t==null?void 0:t.ownerLastName)||"Unknown";r.className="mb-2 flex items-start justify-between gap-2";const i=document.createElement("div"),g=document.createElement("div");g.textContent=`"${a}" ${c}`;const l=document.createElement("div");l.className="text-[11px] text-gray-500 ml-1",l.textContent=o?`updated ${R(o)}`:"";const d=document.createElement("button");d.className="btn btn-xs",d.textContent="Open",d.addEventListener("click",async()=>{const u=(await chrome.storage.local.get({labTrendsByPatient:{}})).labTrendsByPatient[n];if(!u){s.textContent="Stored trends not found";return}const p=`labTrends:${Date.now()}-${Math.random().toString(36).slice(2,8)}`;await chrome.storage.session.set({[p]:u});const b=chrome.runtime.getURL(`trends/index.html?key=${encodeURIComponent(p)}`);await chrome.tabs.create({url:b})}),i.appendChild(g),l.textContent&&i.appendChild(l),r.appendChild(i),r.appendChild(d),f.appendChild(r)})}}function E(){f&&chrome.storage.local.get({labTrendsByPatient:{}},e=>{const n=e.labTrendsByPatient||{},t=Object.entries(n).map(([o,r])=>({key:o,patient:(r==null?void 0:r.patient)||null,updatedAt:(r==null?void 0:r.updatedAt)||null}));P(t)})}m&&m.addEventListener("click",()=>{chrome.storage.local.remove("labTrendsByPatient",()=>{chrome.storage.session.get(null,e=>{const n=Object.keys(e).filter(t=>t==="labTrends"||t.startsWith("labTrends:"));if(!n.length)return s.textContent="Stored lab trends cleared",E();chrome.storage.session.remove(n,()=>{s.textContent="Stored lab trends cleared",E()})})})});E();function R(e){const n=new Date(e);if(Number.isNaN(n.getTime()))return"unknown";const t=Math.max(1,Math.round((Date.now()-n.getTime())/1e3));if(t<60)return`${t} second${t===1?"":"s"} ago`;const o=Math.round(t/60);if(o<60)return`${o} minute${o===1?"":"s"} ago`;const r=Math.round(o/60);if(r<24)return`${r} hour${r===1?"":"s"} ago`;const a=Math.round(r/24);return`${a} day${a===1?"":"s"} ago`}function q(e,n){const t=new Set,o=[],r=a=>{const c=[a.panel,a.testName,a.collectedAt,a.valueRaw,a.unit,a.lowestValue,a.highestValue,a.qualifier].join("|");t.has(c)||(t.add(c),o.push(a))};return e.forEach(r),n.forEach(r),o}
