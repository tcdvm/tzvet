(function(){function R(e){const t=e.cloneNode(!0);return t.querySelectorAll("table").forEach(n=>n.remove()),t.innerText.trim()}function J(e){return(e.textContent||"").replace(/Show More\.\.\.|Show Less/gi," ").replace(/\s+/g," ").trim()}function D(e){return Array.from(e.querySelectorAll("tr")).map(t=>Array.from(t.querySelectorAll("th,td")).map(J)).filter(t=>t.some(n=>n.length>0))}function X(e){return e.split(`
`).map(t=>t.replace(/\s+/g," ").trim()).filter(Boolean)}function Y(e){const t=e.match(/Result Date:\s*([A-Za-z]{3,})\s+(\d{1,2}),\s+(\d{4})\s+(\d{1,2}):(\d{2}):(\d{2})\s*(AM|PM)\b/i);if(!t)return null;const n={jan:"01",feb:"02",mar:"03",apr:"04",may:"05",jun:"06",jul:"07",aug:"08",sep:"09",oct:"10",nov:"11",dec:"12"},r=t[1].slice(0,3).toLowerCase(),i=n[r];if(!i)return null;const l=t[2].padStart(2,"0"),f=t[3];let d=Number(t[4]);const c=t[5],u=t[6],a=t[7].toUpperCase();if(Number.isNaN(d))return`${f}-${i}-${l}`;a==="AM"&&d===12&&(d=0),a==="PM"&&d<12&&(d+=12);const o=String(d).padStart(2,"0");return`${f}-${i}-${l}T${o}:${c}:${u}`}function ee(e){for(const t of e){const n=t.match(/Reference:\s*([A-Za-z0-9-]+)/i);if(n)return n[1]}return null}function te(e){const t=e.findIndex(n=>/Clinic Notes\s*\/\s*Specifics:/i.test(n));if(t!==-1)for(let n=t+1;n<e.length;n++){const r=e[n];if(r&&!/^Lab\b/i.test(r)&&!/^[A-Z]{2,}\d+/i.test(r))return r}return null}function ne(e){const t=[{re:/\bcanine\b/i,value:"Canine"},{re:/\bfeline\b/i,value:"Feline"},{re:/\bavian\b/i,value:"Avian"},{re:/\bequine\b/i,value:"Equine"}],n=[];for(const r of e)for(const i of t)i.re.test(r)&&n.push(i.value);return Array.from(new Set(n))}function I(e){const t=X(e),n=t.find(r=>/Result Date:/i.test(r))||"";return{rawLines:t,sampleDate:n?Y(n):null,reference:ee(t),panel:te(t),species:ne(t)}}function G(e,t){const n=[];if(e){const a=e.querySelector("tfoot");a&&n.push(a.innerText),e.querySelectorAll('tr[class*="footer"], tr[class*="pager"], tr[class*="pagination"]').forEach(o=>{n.push(o.innerText)})}t&&t.querySelectorAll('[class*="pager"], [class*="pagination"], [id*="pager"], [id*="pagination"]').forEach(a=>n.push(a.innerText));let r=null,i=e;for(;i&&i!==document.body&&!r;)i.querySelector&&(r=i.querySelector("select.pageSelection")),i=i.parentElement;if(!r&&t&&(r=t.querySelector("select.pageSelection")),r){const a=r.querySelector("option[selected]")||r.options[r.selectedIndex],o=Number((a==null?void 0:a.textContent)||""),s=r.options.length;if(Number.isFinite(o)&&Number.isFinite(s)&&s>0)return{current:o,total:s,text:`page ${o} of ${s}`,hasMore:s>o}}const f=n.map(a=>String(a||"").replace(/\s+/g," ").trim()).filter(Boolean).join(" "),d=f.match(/page\s+(\d+)\s+of\s+(\d+)/i)||f.match(/page\s+(\d+)\s*\/\s*(\d+)/i)||f.match(/(\d+)\s+of\s+(\d+)\s+pages/i);if(d){const a=Number(d[1]),o=Number(d[2]);if(Number.isFinite(a)&&Number.isFinite(o))return{current:a,total:o,text:d[0],hasMore:o>a}}const c=f.match(/\b\d+\s*-\s*\d+\s+of\s+(\d+)\b/i),u=f.match(/page:\s*\d+\s*of\s*(\d+)/i)||f.match(/\bpage\s+\d+\s+of\s+(\d+)/i);if(c&&u){const a=Number(c[1]),o=Number(u[1]);if(Number.isFinite(a)&&Number.isFinite(o))return{current:1,total:o,text:c[0],hasMore:o>1}}return null}function re(e){const t=e||document,n=t.querySelector('div[id^="patientSideBar"]');if(!n)return{name:null,id:null};const i=(n.innerText||n.textContent||"").split(`
`).map(o=>o.replace(/\s+/g," ").trim()).filter(Boolean);let l=i[0]||null;const f=i.findIndex(o=>/Patient ID:/i.test(o));f>0&&(l=i[f-1]||l),l&&(l=l.replace(/\s*\([^)]*\)\s*$/i,"").trim());const d=i.find(o=>/Patient ID:/i.test(o));let c=null;if(d){const o=d.match(/Patient ID:\s*([A-Za-z_]*\d+)/i);o&&(c=o[1])}const u=t.querySelector('div[id^="ownerSideBar"] span');let a=null;if(u){const s=u.textContent.trim().match(/^([^,]+),/);s&&(a=s[1].trim())}return{name:l,id:c,ownerLastName:a}}function ie(e){if(!e)return e;let t=String(e).replace(/\s+/g," ").trim();return t=t.replace(/^(after hours|stat|emergency)\s+/i,""),/^cbc\s+and\s+absolute\s+reticulocyte\s+count$/i.test(t)||/^after hours cbc$/i.test(t)||/\bcbc\b/i.test(t)?"CBC":/^small animal \(no canine\) panel and electrolytes$/i.test(t)||/^canine chemistry panel and electrolytes$/i.test(t)||/^canine panel and electrolytes$/i.test(t)||/^after hours sa general chemistry panel$/i.test(t)||/chemistry|general chemistry|electrolyte/i.test(t)||/renal panel/i.test(t)?"Chemistry":/urinalysis|urine analysis/i.test(t)?"Urinalysis":/animal.*panel/i.test(t)?"Chemistry":t}function Z(e,t){if(!e)return e;let n=String(e).replace(/\s*:\s*Value\s*$/i,"").replace(/^\s*after hours\s+/i,"").trim();n=n.replace(/\s+/g," "),/^value$/i.test(n)&&t&&(n=String(t).replace(/\s*\([^)]*\)\s*$/,"").trim()),n=n.replace(/\s*\([^)]*(mg\/dL|g\/dL|U\/L|mmol\/L|ug\/dL|%|fL|pg|K\/uL|M\/uL)[^)]*\)\s*$/i,"").trim();const r={"alanine aminotransferase":"Alanine aminotransferase","alkaline phosphatase":"Alk Phosphatase","urea nitrogen (bun)":"Urea Nitrogen",phosphate:"Phosphorus","total bilirubin":"Bilirubin, Total"},i=n.toLowerCase();return r[i]?r[i]:n}function oe(e){const t=e.join(" ").toLowerCase();return/(test|resuts|unit|lowest value|highest value|qualifier)/.test(t)}function ae(e){if(!e.length)return null;const t=a=>a&&String(a).replace(/\.pdf/gi,"").replace(/\(click this!\)|click this!/gi,"(See ezyVet for pdf.)").trim();let n=Z(e[0]||null);const r=t(e[1]||null),i=e[2]||null,l=e[3]||null,f=e[4]||null,d=t(e[5]||null);if(!n)return null;n=n.replace(/\s*:\s*Value\s*$/i,"");const c=r?Number(String(r).replace(/[^\d.+-]/g,"")):NaN,u=Number.isNaN(c)?null:c;return{testName:n,valueRaw:r,value:u,unit:i,lowestValue:l,highestValue:f,qualifier:d}}function se(e){const t=[];return e.forEach(n=>{var f;const r=((f=n.meta)==null?void 0:f.panel)||null,i=ie(r);let l=null;n.nestedTableMatrix.forEach(d=>{var s,p,y;const c=d.map(m=>m.trim()),u=c.filter(Boolean);if(u.length===0||oe(u))return;if(c.length===1&&u.length===1&&l){const m=u[0];m&&(l.valueRaw||(l.valueRaw=m),l.comment=m);return}const a=ae(c);if(!a)return;a.testName=Z(a.testName,r||i);const o={panel:i,originalPanel:r,collectedAt:((s=n.meta)==null?void 0:s.sampleDate)||null,reference:((p=n.meta)==null?void 0:p.reference)||null,species:((y=n.meta)==null?void 0:y.species)||[],...a};t.push(o),l=o})}),t}function le(){const e=document.querySelector(".rtabdetails.clinical.active"),t=document.querySelector(".rtabdetails.animals.active"),n=e||t;if(!n)return{ok:!1,error:"No active clinical or animals tab found"};const r=[];let i=null,l=null;if(e){const c=n.querySelector('div[id^="medicalnotesNotes"]');if(!c)return{ok:!1,error:"No medical notes container found"};l=c.id||null;const u=c.querySelector("table");if(!u)return{ok:!1,error:"No notes table found"};i=G(u,c),u.querySelectorAll("tr").forEach((o,s)=>{const p=o.querySelector("table");if(!p)return;const y=R(o),m=I(y);r.push({rowIndex:s,rowText:y,meta:m,nestedTableText:p.innerText.trim(),nestedTableMatrix:D(p)})})}else{const c=n.querySelector('div[id^="diagnosticResultsListTable"]');if(!c)return{ok:!1,error:"No diagnostics table container found"};const u=c.querySelector("table");if(!u)return{ok:!1,error:"No diagnostics table found"};l=c.id||null,i=G(u,c);const a=c.querySelectorAll('tr[data-testid="DiagnosticResult"]');if(a.length)a.forEach((o,s)=>{let p=o.nextElementSibling;for(;p&&p.tagName==="TR"&&!p.querySelector("table")&&!p.matches('tr[data-testid="DiagnosticResult"]');)p=p.nextElementSibling;if(!p)return;const y=p.querySelector("table");if(!y)return;const m=R(o),L=I(m);r.push({rowIndex:s,rowText:m,meta:L,nestedTableText:y.innerText.trim(),nestedTableMatrix:D(y)})});else{const o=Array.from(u.querySelectorAll("tr"));for(let s=0;s<o.length;s+=1){const p=o[s];if(p.querySelector("table")||p.querySelectorAll("td").length<2)continue;const L=o[s+1];if(!L)continue;const P=L.querySelector("table");if(!P)continue;const Q=R(p),U=I(Q);r.push({rowIndex:s,rowText:Q,meta:U,nestedTableText:P.innerText.trim(),nestedTableMatrix:D(P)})}}}const f=r.filter(c=>{var u;return(u=c.meta)==null?void 0:u.panel}),d=se(f);return{ok:!0,patient:re(n),notesContainerId:l,count:r.length,rows:r,panelRowsCount:f.length,panelRows:f,observations:d,pagination:i}}function ce(...e){try{chrome.runtime.sendMessage({type:"LOG",args:e},()=>{chrome.runtime.lastError&&console.warn("[swLog] sendMessage failed:",chrome.runtime.lastError.message)})}catch(t){console.warn("[swLog] sendMessage threw:",t)}}console.log("TZVet content script loaded on",location.href);const h=(...e)=>{console.log(...e)},b=(...e)=>{console.log(...e)},C="normalizeSpecies";let j=!1,q=null;const W=[{re:/\bCanine\s*\(\s*Dog\s*\)/gi,repl:"Canine"},{re:/\bFeline\s*\(\s*Cat\s*\)/gi,repl:"Feline"}];function K(){const e=document.querySelector("div.rtabdetails.dashboard");return!!(e&&e.classList&&e.classList.contains("active"))}function k(e){if(!e||!e.parentElement)return!0;const t=e.parentElement.tagName.toLowerCase();return["script","style","textarea","input","code","pre","noscript"].includes(t)}function H(e){if(!e||!e.nodeValue)return;let t=e.nodeValue,n=!1;for(const r of W){const i=t.replace(r.re,r.repl);i!==t&&(t=i,n=!0)}n&&(e.nodeValue=t,h("[normalize] text-node changed",e.parentElement,t))}function ue(e){if(!e||!e.textContent)return;const t=e.textContent;let n=t;for(const r of W)n=n.replace(r.re,r.repl);n!==t&&(e.textContent=n,b("[normalize] element updated",e,"->",n))}function B(e=document.body){if(!K()||!e)return;try{const r=e.querySelectorAll&&e.querySelectorAll(".appointmentDescription");r&&r.length&&r.forEach(i=>ue(i))}catch{}const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let n=t.nextNode();for(;n;)k(n)||H(n),n=t.nextNode()}function de(){q||(q=new MutationObserver(e=>{if(K()){h("[normalize] mutations received",e.length);for(const t of e)if(h("[normalize] mutation",t.type),t.type==="characterData"&&t.target&&(k(t.target)||(h("[normalize] characterData change in",t.target.parentElement),H(t.target))),t.type==="childList")for(const n of t.addedNodes)n.nodeType===Node.TEXT_NODE?k(n)||(h("[normalize] added text node",n.parentElement),H(n)):n.nodeType===Node.ELEMENT_NODE&&(h("[normalize] added element",n),B(n))}}),q.observe(document.body,{childList:!0,subtree:!0,characterData:!0}),h("[normalize] observer started"))}function fe(){q&&(q.disconnect(),q=null,h("[normalize] observer disconnected"))}function $(e){j=!!e,j?(B(),de(),console.log("Normalization enabled")):(fe(),console.log("Normalization disabled (existing changes remain)"))}chrome.storage.sync.get({[C]:!1},e=>{$(!!e[C])});chrome.storage.onChanged.addListener((e,t)=>{h("[storage] changes",e,t),t==="sync"&&e[C]&&$(!!e[C].newValue)});const M="headerHidden";let w=!1,N=null;function A(){const e=document.querySelector("header");if(!e)return!1;const t=["display","height","minHeight","maxHeight","paddingTop","paddingBottom","marginTop","marginBottom","overflow","visibility","pointerEvents"];if(w){if(!e.hasAttribute("data-tzvet-prev-style")){const n={};for(const r of t)n[r]=e.style[r]||"";e.setAttribute("data-tzvet-prev-style",JSON.stringify(n))}e.style.display="block",e.style.height="0px",e.style.minHeight="0px",e.style.maxHeight="0px",e.style.paddingTop="0px",e.style.paddingBottom="0px",e.style.marginTop="0px",e.style.marginBottom="0px",e.style.overflow="hidden",e.style.visibility="hidden",e.style.pointerEvents="none",e.setAttribute("aria-hidden","true"),e.setAttribute("data-tzvet-hidden","true"),b("[header] collapsed (no space)")}else{if(e.getAttribute("data-tzvet-hidden")==="true"){const n=e.getAttribute("data-tzvet-prev-style");try{if(n){const r=JSON.parse(n);for(const i of t)r[i]!==void 0&&(e.style[i]=r[i]||"")}else for(const r of t)e.style[r]=""}catch{for(const i of t)e.style[i]=""}e.removeAttribute("data-tzvet-prev-style")}e.removeAttribute("aria-hidden"),e.removeAttribute("data-tzvet-hidden"),b("[header] restored")}return!0}function pe(){N||(N=new MutationObserver(e=>{h("[header] mutations",e.length);for(const t of e)if(t.type==="childList")for(const n of t.addedNodes)n.nodeType===Node.ELEMENT_NODE&&(h("[header] added node",n),n.tagName&&n.tagName.toLowerCase()==="header"?A()&&_():n.querySelector&&n.querySelector("header")&&A()&&_())}),N.observe(document.body,{childList:!0,subtree:!0}),h("[header] observer started"))}function _(){N&&(N.disconnect(),N=null)}function V(e){w=!!e,h("[header] setHeaderVisibility",w),w?(A()||pe(),console.log("[header] hidden")):(_(),A(),console.log("[header] visible"))}chrome.runtime.onMessage.addListener((e,t,n)=>{var r;if(h("[cs] side panel message",e&&e.type),(e==null?void 0:e.type)==="HIGHLIGHT")document.body.style.backgroundColor=e.color||"rgba(255,255,0,0.15)",n({status:"done"});else if((e==null?void 0:e.type)==="NORMALIZE_TOGGLE")$(!!e.enabled),n({status:"ok"});else if((e==null?void 0:e.type)==="NORMALIZE_NOW")B(),n({status:"ran"});else if((e==null?void 0:e.type)==="HEADER_TOGGLE")V(!!e.hidden),n({status:"ok"});else if((e==null?void 0:e.type)==="HEADER_TOGGLE_NOW")A(),n({status:"ran"});else if((e==null?void 0:e.type)==="QTIP_TOGGLE")F(!!e.enabled),n({status:"ok"});else if((e==null?void 0:e.type)==="QTIP_APPLY_NOW")O(),n({status:"ran"});else if((e==null?void 0:e.type)==="EXTRACT_LAB_TRENDS"){try{const i=le();if(ce("Extract lab trends result",i),i!=null&&i.ok&&((r=i.patient)!=null&&r.id)){const l=i.patient.id;chrome.storage.local.get({labTrendsByPatient:{}},f=>{const d=f.labTrendsByPatient||{},u=(d[l]||{patient:i.patient,observations:[]}).observations.concat(i.observations||[]),a=new Set,o=[];u.forEach(s=>{const p=[s.panel,s.testName,s.collectedAt,s.valueRaw,s.unit,s.lowestValue,s.highestValue,s.qualifier].join("|");a.has(p)||(a.add(p),o.push(s))}),d[l]={patient:i.patient,observations:o,updatedAt:new Date().toISOString()},chrome.storage.local.set({labTrendsByPatient:d})})}n(i)}catch(i){const l=(i==null?void 0:i.message)||String(i);console.warn("[cs] extract lab trends failed",i),n({ok:!1,error:l})}return!0}});chrome.storage.sync.get({[M]:!1,qtipPlaceholder:!1},e=>{h("[storage] init",e),V(!!e[M]),F(!!e.qtipPlaceholder)});chrome.storage.onChanged.addListener((e,t)=>{h("[storage] onChanged",e,t),t==="sync"&&(e[M]&&V(!!e[M].newValue),e.qtipPlaceholder&&F(!!e.qtipPlaceholder.newValue))});let v=!1,S=null;const x=".qtip.qtip-default.ezy-tooltip",he='<div class="tzvet-qtip-placeholder" style="padding:6px;color:#374151">(popups disabled)</div>',g=new Map;function E(e){try{const t=e.innerText?e.innerText.trim():"";if(t==="Loading")return!0;const n=e.querySelector(".qtip-content");return n?n.children.length===0&&t.toLowerCase().includes("loading"):t.toLowerCase().includes("loading")}catch{return!1}}function T(e){try{const t=e.querySelector(".qtip-content");if(t&&t.children&&t.children.length){e.hasAttribute("data-tzvet-qtip-original")||e.setAttribute("data-tzvet-qtip-original",e.innerHTML);const n=t.children[0];return t.replaceChildren(n.cloneNode(!0)),e.setAttribute("data-tzvet-qtip-replaced","1"),!0}else return e.hasAttribute("data-tzvet-qtip-original")||e.setAttribute("data-tzvet-qtip-original",e.innerHTML),e.innerHTML=he,e.setAttribute("data-tzvet-qtip-replaced","1"),!0}catch(t){return console.warn("[qtip] replace error",t),!1}}function z(e,t=5e3){if(!e||!(e instanceof HTMLElement)||g.has(e))return;if(!E(e)){T(e);return}b("[qtip] waiting for ready",e);const n=new MutationObserver(()=>{if(!E(e)){const i=g.get(e);i&&i.disconnect(),g.delete(e),T(e)}});g.set(e,n),n.observe(e,{childList:!0,subtree:!0,characterData:!0,attributes:!0});const r=setTimeout(()=>{if(g.has(e)){const i=g.get(e);i&&i.disconnect(),g.delete(e),T(e),b("[qtip] timed out waiting for ready, applied fallback",e)}},t);n._tzvet_timeout=r}function me(){for(const[e,t]of g.entries())try{t&&typeof t.disconnect=="function"&&t.disconnect(),t&&t._tzvet_timeout&&clearTimeout(t._tzvet_timeout)}catch{}g.clear()}function O(e=document.body){try{const t=e.querySelectorAll&&e.querySelectorAll(x)||[];let n=0,r=0;t.forEach(i=>{if(i instanceof HTMLElement){if(v){if(E(i)){z(i);return}T(i)&&n++}else if(i.getAttribute("data-tzvet-qtip-replaced")==="1"){const l=i.getAttribute("data-tzvet-qtip-original");l!==null&&(i.innerHTML=l),i.removeAttribute("data-tzvet-qtip-original"),i.removeAttribute("data-tzvet-qtip-replaced"),r++}}}),b("[qtip] applied",{replaced:n,restored:r,totalFound:t.length},e===document.body?"document":e)}catch(t){console.warn("[qtip] apply error",t)}}function be(){S||(S=new MutationObserver(e=>{b("[qtip] mutations",e.length);for(const t of e)if(t.type==="childList"){for(const n of t.addedNodes)if(n.nodeType===Node.ELEMENT_NODE){const r=n;b("[qtip] added node",r),r.matches&&r.matches(x)?v&&(E(r)?z(r):T(r)):r.querySelector&&r.querySelector(x)&&v&&O(r)}}else if(t.type==="attributes"){const n=t.target;if(b("[qtip] attribute change",t.attributeName,n),n instanceof Element){if(n.matches&&n.matches(x))v&&(E(n)?z(n):T(n));else if(n.querySelector&&n.querySelector(x)){const r=n.querySelector(x);v&&(E(r)?z(r):T(r))}}}}),S.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}),b("[qtip] observer started"))}function ye(){S&&(S.disconnect(),S=null,me(),b("[qtip] observer disconnected"))}function F(e){v=!!e,console.log("[qtip] setQtipReplacement",v),v?(O(),be(),console.log("[qtip] enabled")):(ye(),O(),console.log("[qtip] disabled"))}
})()
