import"./chunks/modulepreload-polyfill.js";/* empty css             */const Q=document.getElementById("status"),B=document.getElementById("panels"),j=document.getElementById("patient"),re=document.getElementById("resultModal"),ie=document.getElementById("resultModalContent"),de={CBC:document.getElementById("panelCbc"),Chemistry:document.getElementById("panelChem"),Urinalysis:document.getElementById("panelUa"),Other:document.getElementById("panelOther")};let H=[],v=new Map,T=null,K=[];const oe=new Map;let Z={disablePanels:new Set,disableTests:new Set};const fe=150;function pe(e){!re||!ie||(ie.textContent=e,re.showModal())}function ge(e){return!e||!e.hasMore?"":`Possible missing labs: page ${e.current} of ${e.total}. Load additional pages or increase items/page.`}function ue(e){return String(e||"").replace(/[“”"'`]/g,"").replace(/\s+/g," ").trim().toLowerCase()}function ee(e){const t=ue(e);return t?t==="ua"||t.includes("urinalysis")||t.includes("urine analysis")?"urinalysis":t.includes("chem")?"chemistry":t.includes("cbc")?"cbc":t:""}function me(e){return ue(e)}async function he(){const e=await chrome.storage.sync.get({trendsDisablePanels:[],trendsDisableTests:[]}),t=Array.isArray(e.trendsDisablePanels)?e.trendsDisablePanels:[],r=Array.isArray(e.trendsDisableTests)?e.trendsDisableTests:[];Z={disablePanels:new Set(t.map(n=>ee(n)).filter(Boolean)),disableTests:new Set(r.map(n=>me(n)).filter(Boolean))}}function W(e,t){const r=ee(e),n=me(t);return!!(Z.disablePanels.has(r)||Z.disableTests.has(n))}function we(e){const t=ee(e);return["cbc","chemistry","urinalysis"].includes(t)?t==="cbc"?"CBC":t==="chemistry"?"Chemistry":"Urinalysis":"Other"}function U(e){if(!e)return"Unknown";if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(e)||/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const t=new Date(e);if(Number.isNaN(t.getTime()))return"Unknown";const r=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${r}-${n}-${s}`}function J(e,t=!1){const r=typeof t=="boolean"?{short:t}:t||{},n=!!r.short,s=!!r.showTime,l=r.showMinutes!==!1;if(e==="Unknown")return"Unknown";const c=e.includes("T")?new Date(e):null;if(c&&!Number.isNaN(c.getTime())){const h=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],E=c.getHours(),S=String(c.getMinutes()).padStart(2,"0"),C=E>=12?"PM":"AM",u=E%12||12,b=`${h[c.getMonth()]} ${c.getDate()}, ${c.getFullYear()}`;if(!s)return n?`${h[c.getMonth()]} ${c.getDate()}`:b;const M=l?`${u}:${S} ${C}`:`${u} ${C}`;return n?`${h[c.getMonth()]} ${c.getDate()} ${M}`:`${b} ${M}`}const d=e.split("-").map(h=>Number(h));if(d.length!==3||d.some(h=>Number.isNaN(h)))return"Unknown";const[w,y,$]=d,m=new Date(w,y-1,$,12);if(Number.isNaN(m.getTime()))return"Unknown";const p=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return n?`${p[m.getMonth()]} ${m.getDate()}`:`${p[m.getMonth()]} ${m.getDate()}, ${m.getFullYear()}`}function le(e){return!e||e==="Unknown"?"Unknown":e.includes("T")?e.split("T")[0]:e}function ye(e){return[...e].sort((t,r)=>{if(t==="Unknown")return 1;if(r==="Unknown")return-1;const n=new Date(t),s=new Date(r);return!Number.isNaN(n.getTime())&&!Number.isNaN(s.getTime())?n.getTime()-s.getTime():t.localeCompare(r)})}function be(e,t,r){return!e||e.length===0?"":e.map(n=>{const s=[];if(n.valueRaw){const l=A(n.valueRaw),c=A(t),d=A(r),w=Number.isFinite(l)&&(Number.isFinite(c)&&l<c||Number.isFinite(d)&&l>d),y=Number.isFinite(l)&&Number.isFinite(c)&&l<c,$=Number.isFinite(l)&&Number.isFinite(d)&&l>d,m=ce(n.valueRaw);let p=w?`<strong>${m}</strong>`:m;y?p+=' <span class="status status-sm status-info align-middle" aria-label="info"></span>':$&&(p+=' <span class="status status-sm status-error align-middle" aria-label="error"></span>'),s.push(p)}return n.qualifier&&s.push(`(${ce(n.qualifier)})`),s.join(" ")}).join("; ")}function A(e){if(e==null)return NaN;const t=String(e).replace(/[^\d.+-]/g,"");return t?Number(t):NaN}function ce(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Ne(e,t,r){const c=e.map((u,b)=>({x:b,y:A(u)})).filter(u=>Number.isFinite(u.y));if(c.length<2)return"";const d=A(t),w=A(r),y=Math.min(...c.map(u=>u.y)),$=Math.max(...c.map(u=>u.y));let m=y,p=$;Number.isFinite(d)&&(m=Math.min(m,d)),Number.isFinite(w)&&(p=Math.max(p,w)),m===p&&(m-=1,p+=1);const h=c.length>1?(90-2*2)/(c.length-1):0,E=u=>22-(u-m)/(p-m)*(24-2*2),S=c.map((u,b)=>`${2+b*h},${E(u.y).toFixed(2)}`).join(" ");let C="";if(Number.isFinite(d)&&Number.isFinite(w)){const u=E(w),b=E(d),M=Math.min(u,b),D=Math.abs(b-u);C=`<rect x="2" y="${M.toFixed(2)}" width="${(90-2*2).toFixed(2)}" height="${D.toFixed(2)}" fill="rgba(148,163,184,0.35)"/>`}return`
    <svg width="90" height="24" viewBox="0 0 90 24" aria-hidden="true">
      ${C}
      <polyline fill="none" stroke="currentColor" stroke-width="1.5" points="${S}" />
    </svg>
  `.trim()}function xe(e){for(const t of e)if(t.unit)return t.unit;return""}function Te(e,t,r){const n=e.find(s=>s.testName===t&&U(s.collectedAt)===r);return n&&(n.lowestValue||n.highestValue)?{low:n.lowestValue||null,high:n.highestValue||null}:{low:null,high:null}}function Ee(e){if(!e)return"";const t=e.low||"",r=e.high||"";return`${t}${t&&r?"-":""}${r}`}function Ce(e){const t=new Map;e.forEach(n=>{const s=n.originalPanel||n.panel||"";if(!s||!n.testName)return;t.has(s)||t.set(s,[]);const l=t.get(s);l.includes(n.testName)||l.push(n.testName)});let r=[];for(const[,n]of t.entries())n.length>r.length&&(r=n);return r}function te(e){K=e,B&&(B.className="relative",B.innerHTML=""),v=new Map;const t=new Map;if(e.forEach(s=>{if(!s.panel||!s.testName)return;const l=we(s.panel);t.has(l)||t.set(l,[]),t.get(l).push(s)}),!t.size){Q.textContent="No panel data found.";return}H=["CBC","Chemistry","Urinalysis","UA","Other"];const r=Array.from(t.entries()).sort((s,l)=>{const c=H.indexOf(s[0]),d=H.indexOf(l[0]),w=c===-1?Number.MAX_SAFE_INTEGER:c,y=d===-1?Number.MAX_SAFE_INTEGER:d;return w!==y?w-y:s[0].localeCompare(l[0])});for(const[s,l]of r){const c=new Set(l.map(a=>U(a.collectedAt))),d=ye(c),w=new Map;d.forEach(a=>{const i=le(a);w.set(i,(w.get(i)||0)+1)});const y=d.filter(a=>l.some(i=>U(i.collectedAt)===a&&(i.lowestValue||i.highestValue))),$=y.length?y[y.length-1]:d.length?d[d.length-1]:"Unknown",m=oe.get(s)||$,p=new Map;l.forEach(a=>{const i=U(a.collectedAt);!p.has(i)&&a.originalPanel&&p.set(i,a.originalPanel)});const h=new Map;l.forEach(a=>{const i=a.testName;h.has(i)||h.set(i,new Map);const o=U(a.collectedAt);h.get(i).has(o)||h.get(i).set(o,[]),h.get(i).get(o).push(a)});const E=y.length>0,S=Array.from(h.entries()).some(([a,i])=>W(s,a)?!1:d.map(f=>{const L=i.get(f)||[];return L.length?L[0].valueRaw:null}).filter(f=>f!=null).map(f=>A(f)).filter(f=>Number.isFinite(f)).length>=2),C=d.length>1&&!W(s,null)&&S,u=document.createElement("section");u.className="card bg-base-200 shadow-sm w-full";const b=document.createElement("div");b.className="card-body",b.innerHTML=`<h2 class="card-title text-lg">${s}</h2>`;const M=document.createElement("div");M.className="overflow-x-auto max-w-full";const D=document.createElement("table");D.className="table table-xs table-pin-rows table-zebra w-fit text-sm bg-base-100 border border-base-300 border-separate border-spacing-0 rounded-none";const ne=document.createElement("thead"),I=document.createElement("tr"),z=document.createElement("th");z.className="w-44 sticky-col sticky-col-header";const se=document.createElement("div");se.textContent="Test";const V=document.createElement("div");V.className="text-[11px] text-gray-400 flex items-center gap-1";const _=document.createElement("span");if(_.textContent="Ref range",_.className="underline underline-offset-2 decoration-dotted decoration-1 text-gray-400 cursor-help",_.title="Reference ranges can be 'iffy' at times from ezyVet. Confirm strange looking ranges from the source or switch to a different date (if available).",V.appendChild(_),y.length>1){const a=document.createElement("select");a.className="select select-xs max-w-28",y.forEach(i=>{const o=document.createElement("option");o.value=i,o.textContent=J(i,{short:!0,showTime:!1}),i===m&&(o.selected=!0),a.appendChild(o)}),a.addEventListener("change",i=>{oe.set(s,i.target.value),te(K),O(s)}),V.appendChild(a)}if(z.appendChild(se),z.appendChild(V),I.appendChild(z),d.forEach(a=>{const i=document.createElement("th");i.className="w-24";const o=document.createElement("span");o.className="cursor-help underline underline-offset-2 decoration-dotted decoration-1 text-gray-500";const f=p.get(a)||s;o.title=f;const L=le(a),P=(w.get(L)||0)>1;if(P&&a.includes("T")){const g=new Date(a);if(Number.isNaN(g.getTime()))o.textContent=J(a,{showTime:P,showMinutes:!1});else{const F=g.getHours(),k=F>=12?"PM":"AM",G=F%12||12;o.textContent=J(a,{showTime:!1});const N=document.createElement("span");N.className="text-[11px] text-gray-400",N.textContent=` (${G} ${k})`,o.appendChild(N)}}else o.textContent=J(a,{showTime:P,showMinutes:!1});i.appendChild(o),I.appendChild(i)}),C){const a=document.createElement("th");a.className="w-28",a.textContent="Trendline",I.appendChild(a)}ne.appendChild(I),D.appendChild(ne);const ae=document.createElement("tbody");let Y=Array.from(h.keys());if(s==="Chemistry"){const a=Ce(l);if(a.length){const i=new Map(a.map((o,f)=>[o,f]));Y=Y.map((o,f)=>({name:o,idx:f,rank:i.has(o)?i.get(o):Number.MAX_SAFE_INTEGER})).sort((o,f)=>o.rank-f.rank||o.idx-f.idx).map(o=>o.name)}}Y.forEach(a=>{const i=document.createElement("tr"),o=document.createElement("td");o.className="w-44 max-w-44 break-words sticky-col";const f=l.filter(N=>N.testName===a),L=xe(f),P=`<span class="font-medium text-base-content">${a}</span>`,g=Te(l,a,m),F=Ee(g),k=[];F?k.push(F):E&&k.push('<span class="text-[11px] text-gray-400 italic">no ref</span>'),L&&k.push(`<span class="text-[11px] text-gray-400">(${L})</span>`);const G=k.length?`<div class="text-[12px] text-gray-500">${k.join(" ")}</div>`:"";if(o.innerHTML=`${P}${G}`,i.appendChild(o),d.forEach(N=>{const x=document.createElement("td"),X=h.get(a).get(N)||[];x.innerHTML=be(X,g==null?void 0:g.low,g==null?void 0:g.high);const R=x.textContent.trim();if(R.length>fe){const q=document.createElement("span");q.className="cell-truncate cell-modal",q.innerHTML=x.innerHTML,x.innerHTML="",x.appendChild(q),x.classList.add("cursor-pointer"),x.title="Click to view full result",x.addEventListener("click",()=>pe(R))}i.appendChild(x)}),C){const N=document.createElement("td");if(N.className="text-slate-500",!W(s,a)){const x=d.map(X=>{const R=h.get(a).get(X)||[];return R.length?R[0].valueRaw:null});N.innerHTML=Ne(x,g==null?void 0:g.low,g==null?void 0:g.high)}i.appendChild(N)}ae.appendChild(i)}),D.appendChild(ae),M.appendChild(D),b.appendChild(M),u.appendChild(b),B.appendChild(u),v.set(s,u)}const n=T&&v.has(T)?T:r.length?r[0][0]:null;O(n)}async function Me(){var s,l;const t=new URLSearchParams(window.location.search).get("key")||"labTrends",n=(await chrome.storage.session.get(t))[t];if(!n||!n.observations){Q.textContent="(No data found. Extract from the side panel first.)",B.innerHTML="",j&&(j.textContent="");return}if(j){const c=((s=n.patient)==null?void 0:s.name)||"Unknown",d=((l=n.patient)==null?void 0:l.ownerLastName)||"Unknown";j.textContent=`"${c}" ${d}`}Q.textContent=ge(n.pagination)||"",await he(),te(n.observations)}function O(e){if(!(!e||!v.has(e))){T=e;for(const[t,r]of v.entries())t===e?r.classList.remove("hidden"):r.classList.add("hidden");$e()}}function $e(){Object.entries(de).forEach(([e,t])=>{if(t){if(!v.has(e)){t.disabled=!0,t.classList.add("btn-disabled"),t.classList.remove("btn-active"),t.classList.remove("btn-outline");return}t.disabled=e===T,t.classList.remove("btn-disabled"),e===T?t.classList.add("btn-active","btn-outline"):t.classList.remove("btn-active","btn-outline")}})}Object.entries(de).forEach(([e,t])=>{t&&t.addEventListener("click",()=>O(e))});document.addEventListener("keydown",e=>{if(!T||!H.length||e.target&&["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName)||!["ArrowLeft","ArrowRight"].includes(e.key))return;const t=H.filter(s=>v.has(s));if(!t.length)return;const r=Math.max(0,t.indexOf(T)),n=e.key==="ArrowLeft"?Math.max(0,r-1):Math.min(t.length-1,r+1);O(t[n])});chrome.storage.onChanged.addListener((e,t)=>{t==="sync"&&(!e.trendsDisablePanels&&!e.trendsDisableTests||he().then(()=>{K.length&&(te(K),O(T))}))});Me();
